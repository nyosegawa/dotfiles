# =============================================================================
# tmux.conf - プロジェクト × 4ペイン構成
# =============================================================================
# Prefix: Ctrl+]
# Shift+左右: ウィンドウ切り替え  (ペイン移動: マウスクリック)
# Option+C: クリア  Option+D: 全クリア  Option+R: 再起動  Option+S: 停止

# --- 基本 ---
set -g default-terminal "tmux-256color"
set -as terminal-features "xterm-ghostty:RGB"
set -g mouse on
set -g set-clipboard on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000

# --- Prefix: Ctrl+] (emacs Ctrl+A/B/E/P/N/F は全て通常動作) ---
unbind C-b
set -g prefix C-]
bind C-] send-prefix

# --- コピーモード: emacs ---
setw -g mode-keys emacs

# --- コピー改善 ---
# ドラッグ終了 → コピーするがコピーモードに留まる (位置も維持)
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-no-clear "pbcopy"

# ダブルクリック: 単語選択 → コピー (コピーモードに留まる)
bind -T copy-mode DoubleClick1Pane select-pane \; send-keys -X select-word \; run-shell -d 0.3 \; send-keys -X copy-pipe-no-clear "pbcopy"
bind -T root        DoubleClick1Pane select-pane -t = \; copy-mode -M \; send-keys -X select-word \; run-shell -d 0.3 \; send-keys -X copy-pipe-no-clear "pbcopy"

# トリプルクリック: 行選択 → コピー (コピーモードに留まる)
bind -T copy-mode TripleClick1Pane select-pane \; send-keys -X select-line \; run-shell -d 0.3 \; send-keys -X copy-pipe-no-clear "pbcopy"
bind -T root        TripleClick1Pane select-pane -t = \; copy-mode -M \; send-keys -X select-line \; run-shell -d 0.3 \; send-keys -X copy-pipe-no-clear "pbcopy"

# Enterでコピーしてコピーモード終了 (明示的に抜けたいとき)
bind -T copy-mode Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# --- スクロール加速 ---
# ゆっくり=3行, 中速=10行, 高速=25行 (scroll-accel.sh で制御)
bind -T copy-mode WheelUpPane   select-pane \; run-shell "$HOME/src/github.com/nyosegawa/dotfiles/tmux/scroll-accel.sh up"
bind -T copy-mode WheelDownPane select-pane \; run-shell "$HOME/src/github.com/nyosegawa/dotfiles/tmux/scroll-accel.sh down"

# =============================================================================
# ウィンドウ切り替え: Shift+左右 (prefix不要)
# =============================================================================
bind -n S-Left  previous-window
bind -n S-Right next-window

# =============================================================================
# Option+キー (prefix不要)
# =============================================================================
bind -n M-c send-keys 'clear' Enter \; clear-history \; display "Pane cleared"

bind -n M-d run-shell ' \
  for pane in $(tmux list-panes -F "##{pane_id}"); do \
    tmux send-keys -t "$pane" "clear" Enter; \
    tmux clear-history -t "$pane"; \
  done; \
  tmux display "All panes cleared"'

bind -n M-r run-shell ' \
  name=$(tmux display-message -p "##W"); \
  dev-tmux restart "$name" 2>&1 | while read line; do tmux display "$line"; done'

# Option+S: ペイン3,4を停止 (Ctrl+C送信)
bind -n M-s run-shell ' \
  win=$(tmux display-message -p "##S:##W"); \
  tmux send-keys -t "${win}.3" C-c; \
  tmux send-keys -t "${win}.4" C-c; \
  tmux display "Panes 3,4 stopped"'

# =============================================================================
# Prefix付き
# =============================================================================
bind q display-panes -d 2000
bind -r W resize-pane -U 3
bind -r S resize-pane -D 3
bind -r A resize-pane -L 3
bind -r D resize-pane -R 3
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# =============================================================================
# ステータスバー
# =============================================================================
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"
set -g status-left "#[fg=#89b4fa,bold] dev "
set -g status-left-length 20
set -g status-right "#[fg=#6c7086]%H:%M "
setw -g window-status-format         "#[fg=#6c7086] #W "
setw -g window-status-current-format "#[fg=#1e1e2e,bg=#89b4fa,bold] #W "
setw -g pane-active-border-style "fg=#89b4fa"
setw -g pane-border-style "fg=#45475a"
set -g display-panes-colour "#6c7086"
set -g display-panes-active-colour "#f38ba8"
set -g display-panes-time 2000
